<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ti·∫øn L√™n Mi·ªÅn Nam - Lobby Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap');
        body { background: #020617; touch-action: manipulation; overflow: hidden; font-family: system-ui; }
        .poker-table {
            background: radial-gradient(circle, #14532d 0%, #064e3b 100%);
            border: 8px solid #451a03;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        }
        .card {
            width: 55px; height: 82px; background: white; border-radius: 6px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4); display: flex; flex-direction: column; padding: 4px; font-weight: bold;
        }
        @media (min-width: 768px) { .card { width: 85px; height: 124px; padding: 8px; } }
        .card.selected { transform: translateY(-30px); border: 3px solid #fbbf24; z-index: 50; filter: brightness(1.1); }
        .card-red { color: #ef4444; }
        .card-black { color: #1f2937; }
        .turn-active { border: 4px solid #fbbf24; box-shadow: 0 0 25px #fbbf24; transform: scale(1.05); }
        .btn-action { transition: all 0.1s; border-bottom: 4px solid rgba(0,0,0,0.3); }
        .btn-action:active { transform: translateY(2px); border-bottom-width: 1px; }
    </style>
</head>
<body class="flex items-center justify-center h-screen w-screen text-white">

<!-- 1. MAIN MENU -->
<div id="lobby-main" class="fixed inset-0 z-[300] bg-slate-900 flex flex-col items-center justify-center p-6 transition-transform">
    <h1 class="text-6xl font-black text-yellow-500 mb-2 italic tracking-tighter" style="font-family: 'Oswald';">TI·∫æN L√äN P2P</h1>
    <div id="net-id-box" class="mb-8 text-blue-400 font-mono text-sm bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
        ID: <span id="my-id-text" class="text-white font-bold tracking-widest">ƒêang t·∫£i...</span>
    </div>

    <div class="space-y-4 w-full max-w-sm">
        <button onclick="ui.startSolo()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-bold text-xl shadow-xl">CH∆†I V·ªöI BOT (OFFLINE)</button>
        
        <div class="h-[1px] bg-slate-700 my-4"></div>

        <div class="flex flex-col gap-2">
            <input id="peer-id-input" type="text" placeholder="D√°n ID Host v√†o ƒë√¢y..." class="w-full px-5 py-4 bg-slate-700 rounded-2xl outline-none focus:ring-2 ring-blue-500 text-white font-mono text-sm">
            <button onclick="net.join()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold text-lg">V√ÄO PH√íNG B·∫†N B√à</button>
        </div>
    </div>
</div>

<!-- 2. WAITING ROOM (NEW) -->
<div id="waiting-room" class="fixed inset-0 z-[250] bg-slate-900 flex flex-col items-center justify-center p-6 hidden">
    <h2 class="text-3xl font-bold text-yellow-500 mb-8 italic">PH√íNG CH·ªú</h2>
    
    <div class="grid grid-cols-2 gap-4 w-full max-w-md mb-12">
        <div class="bg-slate-800 p-6 rounded-3xl border-2 border-blue-500 flex flex-col items-center">
            <div class="text-4xl mb-2">üë§</div>
            <div class="font-bold text-sm">CH·ª¶ PH√íNG</div>
            <div id="host-status" class="text-xs text-green-400 mt-1">ƒêang ch·ªù...</div>
        </div>
        <div class="bg-slate-800 p-6 rounded-3xl border-2 border-dashed border-slate-700 flex flex-col items-center">
            <div class="text-4xl mb-2">üë•</div>
            <div class="font-bold text-sm uppercase">Kh√°ch</div>
            <div id="client-status" class="text-xs text-slate-500 mt-1">Tr·ªëng</div>
        </div>
    </div>

    <div id="host-controls" class="hidden flex flex-col items-center gap-4">
        <button onclick="game.hostStartGame()" class="bg-yellow-500 text-black px-12 py-4 rounded-full font-black text-xl animate-pulse shadow-2xl">B·∫ÆT ƒê·∫¶U CH∆†I</button>
        <p class="text-gray-400 text-sm">B·∫°n l√† ch·ªß ph√≤ng, b·∫•m ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
    </div>

    <div id="client-controls" class="hidden text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent mb-4"></div>
        <p class="text-blue-400 font-bold">ƒêang ƒë·ª£i Ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu v√°n b√†i...</p>
    </div>
</div>

<!-- 3. GAME TABLE -->
<div id="game-ui" class="relative w-full h-full poker-table hidden overflow-hidden">
    <!-- Top & Sides Avatars -->
    <div class="absolute top-4 left-1/2 -translate-x-1/2 flex flex-col items-center">
        <div id="avatar-2" class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-slate-800 border-2 flex items-center justify-center text-2xl shadow-xl">ü§ñ</div>
        <div class="text-[10px] mt-1 bg-black/50 px-2 rounded">Bot 2 (<span id="count-2">13</span>)</div>
    </div>
    <div class="absolute left-4 top-1/2 -translate-y-1/2 flex flex-col items-center">
        <div id="avatar-1" class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-slate-800 border-2 flex items-center justify-center text-2xl shadow-xl">üë§</div>
        <div class="text-[10px] mt-1 bg-black/50 px-2 rounded">P1 (<span id="count-1">13</span>)</div>
    </div>
    <div class="absolute right-4 top-1/2 -translate-y-1/2 flex flex-col items-center">
        <div id="avatar-3" class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-slate-800 border-2 flex items-center justify-center text-2xl shadow-xl">ü§ñ</div>
        <div class="text-[10px] mt-1 bg-black/50 px-2 rounded">Bot 3 (<span id="count-3">13</span>)</div>
    </div>

    <!-- Table Center -->
    <div id="table-center" class="absolute inset-0 flex items-center justify-center -space-x-8 md:-space-x-12 pointer-events-none scale-75 md:scale-100"></div>

    <!-- Player Bottom -->
    <div class="absolute bottom-4 w-full flex flex-col items-center">
        <div id="my-hand" class="flex justify-center -space-x-8 md:-space-x-12 mb-20 h-24"></div>
        <div class="flex gap-2 md:gap-4 scale-90 md:scale-110">
            <button onclick="game.play()" class="btn-action px-8 py-3 bg-yellow-500 text-black rounded-full font-black shadow-lg">ƒê√ÅNH</button>
            <button onclick="game.skip()" class="btn-action px-6 py-3 bg-slate-700 rounded-full font-bold shadow-lg">B·ªé QUA</button>
            <button onclick="game.sort()" class="btn-action px-6 py-3 bg-blue-600 rounded-full font-bold shadow-lg">X·∫æP</button>
        </div>
    </div>

    <div id="msg-overlay" class="absolute inset-0 flex items-center justify-center text-4xl md:text-7xl font-black text-yellow-400 italic uppercase opacity-0 z-[100] transition-all"></div>
</div>

<script>
/** ENGINE DATA **/
const RANKS = ['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
const SUITS = ['‚ô†', '‚ô£', '‚ô¶', '‚ô•'];
const COLORS = ['card-black', 'card-black', 'card-red', 'card-red'];

function createCard(r, s) {
    return { r, s, w: r * 4 + s, name: RANKS[r], icon: SUITS[s], color: COLORS[s], id: `${r}-${s}` };
}

/** NETWORK LOGIC **/
const net = {
    peer: null, conn: null, isHost: false,
    init() {
        this.peer = new Peer();
        this.peer.on('open', id => document.getElementById('my-id-text').innerText = id);
        this.peer.on('connection', c => {
            this.conn = c; this.isHost = true;
            this.setupListeners();
            ui.showWaitingRoom();
            document.getElementById('client-status').innerText = "ƒê√£ v√†o ph√≤ng";
            document.getElementById('client-status').classList.replace('text-slate-500', 'text-green-400');
        });
    },
    join() {
        const id = document.getElementById('peer-id-input').value;
        if (!id) return alert("Vui l√≤ng nh·∫≠p ID!");
        this.conn = this.peer.connect(id);
        this.isHost = false;
        this.setupListeners();
    },
    setupListeners() {
        this.conn.on('open', () => {
            ui.showWaitingRoom();
            if(!this.isHost) {
                document.getElementById('host-status').innerText = "ƒê√£ k·∫øt n·ªëi";
                document.getElementById('client-status').innerText = "B·∫°n ƒë√£ v√†o";
            }
        });
        this.conn.on('data', data => {
            if (data.type === 'START_SIGNAL') {
                game.hands = data.hands;
                game.turn = data.turn;
                game.myIdx = 1;
                ui.showGame();
                game.checkToiTrang();
            }
            if (data.type === 'ACTION_MOVE') game.applyMove(data);
            if (data.type === 'ACTION_SKIP') game.applySkip(data);
        });
    },
    send(data) { if (this.conn) this.conn.send(data); }
};

/** GAME ENGINE **/
const game = {
    hands: [[],[],[],[]], turn: 0, lastMove: null, skipped: [false,false,false,false],
    myIdx: 0, selectedIds: new Set(),

    hostStartGame() {
        const deck = [];
        for(let r=0; r<13; r++) for(let s=0; s<4; s++) deck.push(createCard(r, s));
        deck.sort(() => Math.random() - 0.5);
        
        this.hands = [
            deck.slice(0, 13).sort((a,b)=>a.w - b.w),
            deck.slice(13, 26).sort((a,b)=>a.w - b.w),
            deck.slice(26, 39).sort((a,b)=>a.w - b.w),
            deck.slice(39, 52).sort((a,b)=>a.w - b.w)
        ];
        this.turn = this.findFirst();
        this.myIdx = 0;
        
        // G·ª≠i l·ªánh b·∫Øt ƒë·∫ßu cho Client
        net.send({ type: 'START_SIGNAL', hands: this.hands, turn: this.turn });
        
        ui.showGame();
        this.checkToiTrang();
        ui.render();
        if (this.turn >= 2) setTimeout(() => this.bot(), 1000);
    },

    findFirst() {
        for(let i=0; i<4; i++) if(this.hands[i].some(c => c.w === 0)) return i;
        return 0;
    },

    play() {
        if (this.turn !== this.myIdx) return;
        const cards = this.hands[this.myIdx].filter(c => this.selectedIds.has(c.id));
        const moveType = this.validate(cards);
        
        if (moveType) {
            const data = { type: 'ACTION_MOVE', pIdx: this.myIdx, cards, moveType };
            this.applyMove(data);
            net.send(data);
            this.selectedIds.clear();
        } else ui.showMsg("B√ÄI KH√îNG H·ª¢P L·ªÜ");
    },

    applyMove(data) {
        const { pIdx, cards, moveType } = data;
        this.hands[pIdx] = this.hands[pIdx].filter(hc => !cards.find(cc => cc.id === hc.id));
        this.lastMove = { type: moveType, cards, power: cards[cards.length-1].w };
        ui.renderTable(cards);
        this.next(pIdx);
    },

    skip() {
        if (this.turn !== this.myIdx || !this.lastMove) return;
        const data = { type: 'ACTION_SKIP', pIdx: this.myIdx };
        this.applySkip(data);
        net.send(data);
    },

    applySkip(data) {
        this.skipped[data.pIdx] = true;
        ui.showMsg(`P${data.pIdx} B·ªé L∆Ø·ª¢T`);
        this.next(data.pIdx);
    },

    next(currentP) {
        if (this.hands[currentP].length === 0) {
            ui.showMsg(`NG∆Ø·ªúI CH∆†I ${currentP} TH·∫ÆNG!`);
            setTimeout(() => location.reload(), 5000);
            return;
        }
        
        this.turn = (this.turn + 1) % 4;
        const active = this.skipped.filter(s => !s).length;
        if (active === 1 && !this.skipped[this.turn]) {
            this.skipped = [false,false,false,false];
            this.lastMove = null;
            ui.showMsg("V√íNG M·ªöI");
        } else if (this.skipped[this.turn]) {
            this.next(this.turn);
            return;
        }
        
        ui.render();
        if (net.isHost && this.turn >= 2) setTimeout(() => this.bot(), 1000);
    },

    validate(cards) {
        if (!cards.length) return null;
        const len = cards.length;
        const sorted = [...cards].sort((a,b)=>a.w-b.w);
        if (!this.lastMove) return len <= 2 ? (len === 1 ? 'single' : (sorted[0].r === sorted[1].r ? 'pair' : null)) : null;
        if (this.lastMove.type === 'single' && len === 1 && sorted[0].w > this.lastMove.power) return 'single';
        if (this.lastMove.type === 'pair' && len === 2 && sorted[0].r === sorted[1].r && sorted[1].w > this.lastMove.power) return 'pair';
        return null;
    },

    bot() {
        const hand = this.hands[this.turn];
        let cards = null, type = null;
        if (!this.lastMove) { cards = [hand[0]]; type = 'single'; }
        else if (this.lastMove.type === 'single') {
            const b = hand.find(c => c.w > this.lastMove.power);
            if (b) { cards = [b]; type = 'single'; }
        }
        
        if (cards) {
            const data = { type: 'ACTION_MOVE', pIdx: this.turn, cards, moveType: type };
            this.applyMove(data);
            net.send(data);
        } else {
            const data = { type: 'ACTION_SKIP', pIdx: this.turn };
            this.applySkip(data);
            net.send(data);
        }
    },

    checkToiTrang() {
        this.hands.forEach((h, i) => {
            const c = Array(13).fill(0);
            h.forEach(card => c[card.r]++);
            if (c[12] === 4 || c.every(x => x > 0)) {
                ui.showMsg(`P${i} T·ªöI TR·∫ÆNG!`);
                setTimeout(() => location.reload(), 5000);
            }
        });
    },

    sort() { this.hands[this.myIdx].sort((a,b)=>a.w-b.w); ui.render(); }
};

/** UI RENDERER **/
const ui = {
    showWaitingRoom() {
        document.getElementById('lobby-main').classList.add('hidden');
        document.getElementById('waiting-room').classList.remove('hidden');
        if (net.isHost) document.getElementById('host-controls').classList.remove('hidden');
        else document.getElementById('client-controls').classList.remove('hidden');
    },
    showGame() {
        document.getElementById('waiting-room').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        this.render();
    },
    render() {
        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = '';
        game.hands[game.myIdx].forEach(c => {
            const d = document.createElement('div');
            d.className = `card ${c.color} ${game.selectedIds.has(c.id) ? 'selected' : ''}`;
            d.innerHTML = `<span class="text-xl md:text-2xl leading-none">${c.name}</span><span class="text-3xl md:text-5xl">${c.icon}</span>`;
            d.onclick = () => {
                if(game.turn !== game.myIdx) return;
                game.selectedIds.has(c.id) ? game.selectedIds.delete(c.id) : game.selectedIds.add(c.id);
                this.render();
            };
            handDiv.appendChild(d);
        });

        for(let i=1; i<4; i++) {
            const idx = (game.myIdx + i) % 4;
            document.getElementById(`count-${i}`).innerText = game.hands[idx].length;
            const av = document.getElementById(`avatar-${i}`);
            game.turn === idx ? av.classList.add('turn-active') : av.classList.remove('turn-active');
        }
    },
    renderTable(cards) {
        const center = document.getElementById('table-center');
        center.innerHTML = '';
        cards.forEach(c => {
            const d = document.createElement('div');
            d.className = `card ${c.color}`;
            d.innerHTML = `<span class="text-xl leading-none">${c.name}</span><span class="text-3xl">${c.icon}</span>`;
            center.appendChild(d);
        });
    },
    showMsg(txt) {
        const el = document.getElementById('msg-overlay');
        el.innerText = txt;
        el.classList.remove('opacity-0', 'scale-50');
        el.classList.add('opacity-100', 'scale-100');
        setTimeout(() => { el.classList.add('opacity-0', 'scale-50'); el.classList.remove('opacity-100', 'scale-100'); }, 2000);
    },
    startSolo() { game.myIdx = 0; game.hostStartGame(); }
};

net.init();
</script>
</body>
</html>
