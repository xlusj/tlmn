<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ti·∫øn L√™n Mi·ªÅn Nam - Grand Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #070a0e; overflow: hidden; touch-action: manipulation; }
        .casino-bg { background: radial-gradient(circle at center, #1a4731 0%, #0a1f14 100%); }
        .card {
            width: 60px; height: 88px; background: white; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; padding: 4px; border: 1px solid #ddd;
        }
        @media (min-width: 768px) { .card { width: 90px; height: 128px; padding: 8px; } }
        .card.selected { transform: translateY(-35px) scale(1.05); border: 3px solid #facc15; z-index: 50; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card-red { color: #e11d48; }
        .card-black { color: #1e293b; }
        .avatar-box { border: 3px solid transparent; transition: all 0.3s; }
        .active-turn { border-color: #facc15; box-shadow: 0 0 15px #facc15; transform: scale(1.1); }
        .lobby-panel { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
        #msg-popup { text-shadow: 0 0 20px rgba(250, 204, 21, 0.8); pointer-events: none; }
    </style>
</head>
<body class="flex items-center justify-center h-screen w-screen text-white select-none">

<!-- LOBBY & WAITING ROOM -->
<div id="ui-lobby" class="fixed inset-0 z-[500] lobby-panel flex flex-col items-center justify-center p-6 text-center">
    <div id="lobby-home" class="w-full max-w-md animate-in fade-in duration-500">
        <h1 class="text-5xl font-black text-yellow-500 italic mb-2 tracking-tighter">TI·∫æN L√äN</h1>
        <p class="text-slate-400 text-sm mb-12 uppercase tracking-widest">Grand Master Edition</p>
        
        <div class="space-y-4">
            <button onclick="app.startSolo()" class="w-full py-4 bg-emerald-600 rounded-2xl font-bold text-xl shadow-lg hover:bg-emerald-500 transition-all border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1">CH∆†I V·ªöI BOT</button>
            <div class="py-4 flex items-center gap-2"><div class="h-px bg-slate-700 flex-1"></div><span class="text-slate-500 text-xs">HO·∫∂C CH∆†I ONLINE</span><div class="h-px bg-slate-700 flex-1"></div></div>
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <p class="text-[10px] text-slate-500 mb-1">ID C·ª¶A B·∫†N</p>
                <div id="my-peer-id" class="text-xl font-mono font-bold text-yellow-400 tracking-wider italic">ƒêang l·∫•y m√£...</div>
            </div>
            <div class="relative group">
                <input id="input-peer-id" type="text" placeholder="Nh·∫≠p ID Host ƒë·ªÉ v√†o..." class="w-full px-5 py-4 bg-slate-700 rounded-xl border border-slate-600 outline-none focus:ring-2 ring-yellow-500 transition-all">
                <button onclick="net.join()" class="absolute right-2 top-2 bottom-2 bg-blue-600 px-6 rounded-lg font-bold">V√ÄO</button>
            </div>
        </div>
    </div>

    <!-- WAITING ROOM VIEW -->
    <div id="lobby-waiting" class="hidden w-full max-w-md animate-in slide-in-from-bottom duration-500">
        <h2 class="text-2xl font-bold text-yellow-400 mb-8">PH√íNG CH·ªú</h2>
        <div class="grid grid-cols-2 gap-4 mb-12">
            <div class="bg-slate-800 p-6 rounded-2xl border-2 border-emerald-500 relative overflow-hidden">
                <div class="text-3xl mb-2">üëë</div>
                <div class="text-xs text-slate-400">HOST</div>
                <div class="font-bold">ƒê√É S·∫¥N S√ÄNG</div>
            </div>
            <div id="slot-client" class="bg-slate-800 p-6 rounded-2xl border-2 border-dashed border-slate-700">
                <div class="text-3xl mb-2 opacity-30">üë§</div>
                <div id="client-name" class="text-xs text-slate-500 tracking-tighter">ƒêANG ƒê·ª¢I KH√ÅCH...</div>
            </div>
        </div>
        <div id="host-start-btn" class="hidden flex flex-col items-center gap-4">
            <button onclick="game.hostInitiate()" class="w-full py-5 bg-yellow-500 text-black rounded-full font-black text-2xl shadow-[0_0_30px_rgba(234,179,8,0.4)] hover:scale-105 active:scale-95 transition-all">B·∫ÆT ƒê·∫¶U V√ÅN B√ÄI</button>
            <p class="text-yellow-500/50 text-xs animate-pulse">Ch·ªâ Host m·ªõi c√≥ quy·ªÅn b·∫Øt ƒë·∫ßu</p>
        </div>
        <div id="client-wait-msg" class="hidden">
            <div class="flex items-center justify-center gap-2 text-blue-400 font-bold">
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                VUI L√íNG ƒê·ª¢I CH·ª¶ PH√íNG...
            </div>
        </div>
    </div>
</div>

<!-- GAME TABLE -->
<div id="game-table" class="fixed inset-0 casino-bg hidden flex flex-col justify-between p-4 md:p-8">
    <!-- Top -->
    <div id="player-2" class="flex flex-col items-center">
        <div class="avatar-box w-14 h-14 md:w-20 md:h-20 bg-slate-800 rounded-full flex items-center justify-center text-3xl shadow-2xl relative">ü§ñ</div>
        <div class="bg-black/40 px-3 py-1 rounded-full text-[10px] mt-2 font-bold">BOT 2 (<span id="count-2">13</span>)</div>
    </div>

    <!-- Center -->
    <div class="flex justify-between items-center w-full px-2 md:px-20">
        <div id="player-1" class="flex flex-col items-center">
            <div class="avatar-box w-14 h-14 md:w-20 md:h-20 bg-slate-800 rounded-full flex items-center justify-center text-3xl shadow-2xl">üë§</div>
            <div class="bg-black/40 px-3 py-1 rounded-full text-[10px] mt-2 font-bold">P1 (<span id="count-1">13</span>)</div>
        </div>
        
        <!-- Field -->
        <div id="table-field" class="flex-1 flex justify-center items-center -space-x-10 md:-space-x-16 perspective-1000"></div>

        <div id="player-3" class="flex flex-col items-center">
            <div class="avatar-box w-14 h-14 md:w-20 md:h-20 bg-slate-800 rounded-full flex items-center justify-center text-3xl shadow-2xl">ü§ñ</div>
            <div class="bg-black/40 px-3 py-1 rounded-full text-[10px] mt-2 font-bold">BOT 3 (<span id="count-3">13</span>)</div>
        </div>
    </div>

    <!-- Bottom (You) -->
    <div id="player-0" class="flex flex-col items-center">
        <div id="my-hand" class="flex justify-center -space-x-8 md:-space-x-12 mb-20 md:mb-28 h-24"></div>
        <div class="fixed bottom-6 flex gap-3 md:gap-6 scale-90 md:scale-100">
            <button onclick="game.handleSkip()" class="px-6 md:px-10 py-3 bg-slate-700/80 rounded-full font-bold border-b-4 border-slate-900 shadow-xl">B·ªé L∆Ø·ª¢T</button>
            <button onclick="game.handlePlay()" class="px-10 md:px-16 py-3 bg-yellow-500 text-black rounded-full font-black text-xl border-b-4 border-yellow-700 shadow-[0_0_20px_rgba(234,179,8,0.3)]">ƒê√ÅNH</button>
            <button onclick="game.sortHand()" class="px-6 md:px-10 py-3 bg-blue-600 rounded-full font-bold border-b-4 border-blue-900 shadow-xl">X·∫æP B√ÄI</button>
        </div>
    </div>

    <div id="msg-popup" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl md:text-8xl font-black text-yellow-400 italic uppercase opacity-0 transition-all duration-500 scale-50 z-[1000]"></div>
</div>

<!-- Background Music -->
<audio id="bgm" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3" type="audio/mpeg">
</audio>

<script>
/** 1. SOUND MANAGER (Web Audio API) **/
const snd = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    play(freq, type, duration, vol=0.1) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    },
    card() { this.play(400, 'sine', 0.1); setTimeout(() => this.play(200, 'sine', 0.1), 50); },
    deal() { this.play(800, 'square', 0.05, 0.05); },
    win() { [440, 554, 659, 880].forEach((f, i) => setTimeout(() => this.play(f, 'triangle', 0.5), i * 150)); },
    error() { this.play(100, 'sawtooth', 0.2); }
};

/** 2. RULE ENGINE **/
const Rule = {
    getCombo(cards) {
        if (!cards.length) return null;
        const s = [...cards].sort((a,b) => a.w - b.w);
        const len = s.length;
        const r = s.map(c => c.r);
        
        if (len === 1) return { type: 'single', power: s[0].w };
        
        const isSameRank = r.every(v => v === r[0]);
        if (len === 2 && isSameRank) return { type: 'pair', power: s[1].w };
        if (len === 3 && isSameRank) return { type: 'triple', power: s[2].w };
        if (len === 4 && isSameRank) return { type: 'quad', power: s[3].w };

        // Straight (S·∫£nh) - Kh√¥ng ch·ª©a heo (r=12)
        const isStraight = r.every((v, i) => i === 0 || v === r[i-1] + 1) && !r.includes(12);
        if (len >= 3 && isStraight) return { type: 'straight', power: s[len-1].w, len };

        return null;
    },
    canBeat(newMove, lastMove, isFirstTurn) {
        const combo = this.getCombo(newMove);
        if (!combo) return false;

        // L∆∞·ª£t ƒë·∫ßu ti√™n: B·∫Øt bu·ªôc c√≥ 3 b√≠ch (weight = 0)
        if (isFirstTurn) {
            return newMove.some(c => c.w === 0);
        }

        if (!lastMove) return true;
        if (combo.type === lastMove.type && (combo.len || 0) === (lastMove.len || 0)) {
            return combo.power > lastMove.power;
        }
        
        // Ch·∫∑t heo b·∫±ng t·ª© qu√Ω
        if (lastMove.type === 'single' && lastMove.power >= 48 && combo.type === 'quad') return true;
        
        return false;
    }
};

/** 3. GAME CORE **/
const game = {
    hands: [[],[],[],[]], turn: 0, lastMove: null, lastMover: null,
    skipped: [false,false,false,false], myIdx: 0, selectedIds: new Set(),
    isFirstMove: true,

    init(deckData) {
        if (deckData) {
            this.hands = deckData;
        } else {
            const deck = [];
            for(let r=0; r<13; r++) for(let s=0; s<4; s++) deck.push({ r, s, w: r*4+s, n: RANKS[r], i: SUITS[s], c: COLORS[s], id: `${r}-${s}` });
            deck.sort(() => Math.random() - 0.5);
            this.hands = [0,1,2,3].map(i => deck.slice(i*13, (i+1)*13).sort((a,b)=>a.w - b.w));
        }
        
        this.turn = this.findStart();
        this.isFirstMove = true;
        this.render();
        ui.hideLobby();
        if (this.turn !== this.myIdx && net.isHost) setTimeout(() => this.botPlay(), 1500);
    },

    findStart() {
        for(let i=0; i<4; i++) if (this.hands[i].some(c => c.w === 0)) return i;
        return 0;
    },

    handlePlay() {
        if (this.turn !== this.myIdx) return;
        const selected = this.hands[this.myIdx].filter(c => this.selectedIds.has(c.id));
        if (Rule.canBeat(selected, this.lastMove, this.isFirstMove)) {
            const data = { type: 'MOVE', pIdx: this.myIdx, cards: selected, combo: Rule.getCombo(selected) };
            this.applyMove(data);
            net.send(data);
            this.selectedIds.clear();
            snd.card();
        } else {
            snd.error();
            ui.msg("B√ÄI KH√îNG H·ª¢P L·ªÜ!");
        }
    },

    applyMove(data) {
        const { pIdx, cards, combo } = data;
        this.hands[pIdx] = this.hands[pIdx].filter(hc => !cards.find(cc => cc.id === hc.id));
        this.lastMove = combo;
        this.lastMover = pIdx;
        this.isFirstMove = false;
        ui.renderField(cards);
        this.nextTurn(pIdx);
    },

    handleSkip() {
        if (this.turn !== this.myIdx || !this.lastMove) return;
        const data = { type: 'SKIP', pIdx: this.myIdx };
        this.applySkip(data);
        net.send(data);
    },

    applySkip(data) {
        this.skipped[data.pIdx] = true;
        ui.msg(`P${data.pIdx} B·ªé L∆Ø·ª¢T`);
        this.nextTurn(data.pIdx);
    },

    nextTurn(current) {
        if (this.hands[current].length === 0) {
            ui.msg(`P${current} CHI·∫æN TH·∫ÆNG!`);
            snd.win();
            setTimeout(() => location.reload(), 5000);
            return;
        }

        this.turn = (this.turn + 1) % 4;
        const active = this.skipped.filter(s => !s).length;
        
        if (active === 1 && !this.skipped[this.turn]) {
            this.skipped = [false,false,false,false];
            this.lastMove = null;
            ui.msg("V√íNG M·ªöI");
        } else if (this.skipped[this.turn]) {
            this.nextTurn(this.turn);
            return;
        }

        this.render();
        if (this.turn !== this.myIdx && net.isHost) setTimeout(() => this.botPlay(), 1200);
    },

    botPlay() {
        if (this.turn === 1 && net.conn) return; // Wait for real player
        const hand = this.hands[this.turn];
        let move = null;

        if (this.isFirstMove) {
            // Bot b·∫Øt bu·ªôc ƒë√°nh 3 b√≠ch
            const threeSpade = hand.find(c => c.w === 0);
            move = [threeSpade];
        } else if (!this.lastMove) {
            move = [hand[0]];
        } else if (this.lastMove.type === 'single') {
            const b = hand.find(c => c.w > this.lastMove.power);
            if (b) move = [b];
        }

        if (move) {
            const data = { type: 'MOVE', pIdx: this.turn, cards: move, combo: Rule.getCombo(move) };
            this.applyMove(data);
            net.send(data);
            snd.card();
        } else {
            const data = { type: 'SKIP', pIdx: this.turn };
            this.applySkip(data);
            net.send(data);
        }
    },

    sortHand() { this.hands[this.myIdx].sort((a,b)=>a.w - b.w); this.render(); },
    render() { ui.render(); },

    hostInitiate() {
        this.init();
        net.send({ type: 'START_GAME', hands: this.hands, turn: this.turn });
    }
};

/** 4. NETWORK **/
const net = {
    peer: null, conn: null, isHost: false,
    init() {
        this.peer = new Peer();
        this.peer.on('open', id => document.getElementById('my-peer-id').innerText = id);
        this.peer.on('connection', c => {
            if (this.conn) return; 
            this.conn = c; this.isHost = true;
            this.setupListeners();
            ui.showWaiting(true);
        });
    },
    join() {
        const id = document.getElementById('input-peer-id').value;
        if (!id) return;
        this.conn = this.peer.connect(id);
        this.isHost = false;
        this.setupListeners();
        ui.showWaiting(false);
    },
    setupListeners() {
        this.conn.on('open', () => {
            document.getElementById('slot-client').classList.replace('border-slate-700', 'border-blue-500');
            document.getElementById('client-name').innerText = "B·∫†N B√à ƒê√É V√ÄO";
        });
        this.conn.on('data', data => {
            if (data.type === 'START_GAME') {
                game.myIdx = 1; game.init(data.hands); game.turn = data.turn;
            }
            if (data.type === 'MOVE') game.applyMove(data);
            if (data.type === 'SKIP') game.applySkip(data);
        });
    },
    send(data) { if (this.conn && this.conn.open) this.conn.send(data); }
};

/** 5. UI RENDERER **/
const ui = {
    render() {
        const hDiv = document.getElementById('my-hand');
        hDiv.innerHTML = '';
        game.hands[game.myIdx].forEach(c => {
            const el = document.createElement('div');
            el.className = `card ${c.c} ${game.selectedIds.has(c.id) ? 'selected' : ''}`;
            el.innerHTML = `<span class="text-xl md:text-3xl font-black leading-none">${c.n}</span><span class="text-3xl md:text-5xl">${c.i}</span>`;
            el.onclick = () => {
                if (game.turn !== game.myIdx) return;
                game.selectedIds.has(c.id) ? game.selectedIds.delete(c.id) : game.selectedIds.add(c.id);
                this.render();
            };
            hDiv.appendChild(el);
        });

        [1,2,3].forEach(i => {
            const realIdx = (game.myIdx + i) % 4;
            document.getElementById(`count-${i}`).innerText = game.hands[realIdx].length;
            const av = document.querySelector(`#player-${i} .avatar-box`);
            game.turn === realIdx ? av.classList.add('active-turn') : av.classList.remove('active-turn');
        });
    },
    renderField(cards) {
        const f = document.getElementById('table-field');
        f.innerHTML = '';
        cards.forEach(c => {
            const el = document.createElement('div');
            el.className = `card ${c.c} scale-90 md:scale-100 rotate-${Math.floor(Math.random()*10)-5}`;
            el.innerHTML = `<span class="text-xl md:text-2xl font-black leading-none">${c.n}</span><span class="text-2xl md:text-4xl">${c.i}</span>`;
            f.appendChild(el);
        });
    },
    msg(t) {
        const el = document.getElementById('msg-popup');
        el.innerText = t;
        el.className = "fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl md:text-8xl font-black text-yellow-400 italic uppercase opacity-100 scale-110 z-[1000] transition-all duration-300";
        setTimeout(() => el.className = "fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl md:text-8xl font-black text-yellow-400 italic uppercase opacity-0 scale-50 z-[1000] transition-all duration-500", 1500);
    },
    showWaiting(isHost) {
        document.getElementById('lobby-home').classList.add('hidden');
        document.getElementById('lobby-waiting').classList.remove('hidden');
        if (isHost) document.getElementById('host-start-btn').classList.remove('hidden');
        else document.getElementById('client-wait-msg').classList.remove('hidden');
    },
    hideLobby() { 
        document.getElementById('ui-lobby').classList.add('hidden'); 
        document.getElementById('game-table').classList.remove('hidden'); 
        document.getElementById('bgm').play();
    },
    startSolo() { game.myIdx = 0; game.init(); }
};

const RANKS = ['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
const SUITS = ['‚ô†', '‚ô£', '‚ô¶', '‚ô•'];
const COLORS = ['card-black', 'card-black', 'card-red', 'card-red'];

const app = {
    startSolo() {
        snd.ctx.resume();
        ui.hideLobby();
        game.myIdx = 0;
        game.init();
    }
}

net.init();
</script>
</body>
</html>
